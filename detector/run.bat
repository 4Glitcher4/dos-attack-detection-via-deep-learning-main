@echo off

rem –†–∞–∑—Ä–µ—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–∏–∫–ª–æ–≤.
setlocal EnableDelayedExpansion

rem –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ Windows.
chcp 65001 >nul

set "CONDA_LOCATION=C:\Users\%USERNAME%\miniconda3\Scripts\activate.bat"

for /f %%i in ("%~dp0.") do set "SCRIPT_DIR=%%~si"

set "VENV_DIR=.venv"
set "ENV_PREFIX=%SCRIPT_DIR%\%VENV_DIR%"

rem –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
if "%PROCESSOR_ARCHITECTURE%" equ "amd64" (
  >nul 2>&1 "%SYSTEMROOT%\SysWOW64\cacls.exe" "%SYSTEMROOT%\SysWOW64\config\system"
) else (
  >nul 2>&1 "%SYSTEMROOT%\System32\cacls.exe" "%SYSTEMROOT%\System32\config\system"
)

rem –ï—Å–ª–∏ —Ñ–ª–∞–≥ –æ—à–∏–±–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É –Ω–∞—Å –Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
if "%ERRORLEVEL%" neq "0" (
  echo –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...
  goto UACPrompt
) else (
  echo –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ–ª—É—á–µ–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º...
  goto gotAdmin
)

rem –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏.
:UACPrompt
  echo Set UAC = CreateObject^("Shell.Application"^) > "%TEMP%\getadmin.vbs"
  set params= %*
  echo UAC.ShellExecute "cmd.exe", "/c ""%~s0"" %params:"=""%", "", "runas", 1 >> "%temp%\getadmin.vbs"

  "%TEMP%\getadmin.vbs"
  del "%TEMP%\getadmin.vbs"
  exit /b

rem –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞.
:gotAdmin
  pushd "%CD%"
  cd /d "%~dp0"

rem –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç.
echo –ß—Ç–æ–±—ã –≤—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –Ω–∞–∂–º–∏—Ç–µ [1mCtrl+C[0m, –∞ –∑–∞—Ç–µ–º [1mY[0m.

rem –ü—ã—Ç–∞–µ–º—Å—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å Conda –∏ –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ —É–¥–∞–ª–æ—Å—å
rem –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å. –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º.
echo –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ª–∏ Conda.
call "%CONDA_LOCATION%"
if %ERRORLEVEL% neq 0 (
  echo –û–π. –ú—ã –Ω–µ –º–æ–∂–µ–º –Ω–∞–π—Ç–∏ Conda –Ω–∞ –≤–∞—à–µ–º –ü–ö.
  echo –ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π, –≤–∞–º –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Miniconda –∏–ª–∏ Anaconda.
  echo –í—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è Windows –∑–¥–µ—Å—å: [94;1mhttps://repo.anaconda.com/miniconda/Miniconda3-py39_23.1.0-1-Windows-x86_64.exe[0m
  echo –ï—Å–ª–∏ –≤—ã —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ Conda, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—É—Ç—å –∫ `activate.bat` –≤ `run.bat` —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
  echo –û–∂–∏–¥–∞–µ–º 5 —Å–µ–∫—É–Ω–¥, –∞ –∑–∞—Ç–µ–º –≤—ã—Ö–æ–¥–∏–º... ^(–Ω–∞–∂–º–∏—Ç–µ Ctrl+C –∏ Y, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å —Å—Ä–∞–∑—É^)
  timeout /t 5 >nul
  exit /b 1
)
echo –ú—ã –Ω–∞—à–ª–∏ Conda.

rem –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Conda 'python39'.
set CONDA_DEFAULT_ENV=%CONDA_DEFAULT_ENV:"=%
if "%CONDA_DEFAULT_ENV%"=="%ENV_PREFIX%" (
  rem –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ 'python39' –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
  echo –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è Conda –≤ –ø–∞–ø–∫–µ '%ENV_PREFIX%' —É–∂–µ –±—ã–ª–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ...
) else (
  rem –ï—Å–ª–∏ 'python39' Conda –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ:
  rem –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ 'python39' Conda –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏–ª–∏ –Ω–µ—Ç
  call conda env list | findstr /i /c:%SCRIPT_DIR% | findstr /i /c:%VENV_DIR% >nul
  if !ERRORLEVEL! equ 0 (
    call :activateEnv
  ) else (
    call :promptToCreateNewEnv
  )
)

rem –ï—Å–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞.
if %ERRORLEVEL% neq 0 (
  exit /b 1
)

rem –ü–µ—á–∞—Ç–∞–µ–º –≤–µ—Ä—Å–∏–∏ Conda –∏ Python.
echo –í–µ—Ä—Å–∏—è Conda:
call conda -V
echo –í–µ—Ä—Å–∏—è Python:
call python --version
echo –¢–µ–∫—É—â–∞—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞:
echo %CONDA_DEFAULT_ENV%

rem –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ pip. –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è, –ø—ã—Ç–∞–µ–º—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ–≥–æ.
rem –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö, —á—Ç–æ–±—ã –Ω–µ
rem –∑–∞—Å–æ—Ä—è—Ç—å –≤—ã–≤–æ–¥.
where pip >nul 2>nul
if %ERRORLEVEL% equ 0 (
  echo –ú—ã –Ω–∞—à–ª–∏ pip. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ.
  call :pipInstallRequirements
) else (
  echo –û–π. –ú—ã –Ω–µ –º–æ–∂–µ–º –Ω–∞–π—Ç–∏ pip –Ω–∞ –≤–∞—à–µ–º –ü–ö.
  call conda install pip
  if %ERRORLEVEL% equ 0 (
    echo pip —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ.
    call :pipInstallRequirements
  ) else (
    echo –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pip. –í—ã—Ö–æ–¥–∏–º...
    exit /b 1
  )
)

rem –ï—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤—ã—à–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞.
if %ERRORLEVEL% neq 0 (
  exit /b 1
)

rem –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç main.py.
call python %~dp0src\main.py

goto :eof

rem –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —É—Å—Ç–∞–Ω–æ–∞–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ pip.
:pipInstallRequirements
echo –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ pip.
pip install -r requirements.txt
if %ERRORLEVEL% neq 0 (
  echo –û–π. –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ú—ã –Ω–µ –º–æ–∂–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ pip.
  echo –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ pip –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ª–∏ –ø—É—Ç—å –∫ –Ω–µ–º—É.
  echo –í—ã—Ö–æ–¥–∏–º...
  exit /b 1
)
goto :eof

rem –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
:activateEnv
echo –û–∫—Ä—É–∂–µ–Ω–∏–µ '%ENV_PREFIX%' –Ω–∞–π–¥–µ–Ω–æ –≤ Conda. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ–≥–æ.
call conda activate %ENV_PREFIX%
if %ERRORLEVEL% equ 0 (
  echo –û–∫—Ä—É–∂–µ–Ω–∏–µ '%ENV_PREFIX%' –¥–ª—è Conda –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ.
) else (
  echo –ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ '%ENV_PREFIX%' –¥–ª—è Conda. –í—ã—Ö–æ–¥–∏–º...
  exit /b 1
)
goto :eof

rem –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
:promptToCreateNewEnv
echo –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ '%ENV_PREFIX%' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ Conda.
echo –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è Conda –Ω–∞ –æ—Å–Ω–æ–≤–µ Python 3.9?
echo –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ, –ª–∞—Ç–∏–Ω—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏:
echo ^ ^ y - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo ^ ^ n - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ ^(%CONDA_DEFAULT_ENV%^)
echo ^ ^ a - –æ—Ç–º–µ–Ω–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É
set /p "NEW_ENV_RSP=–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ [y/n/a]: "
rem –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ 'python39' –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if /i "!NEW_ENV_RSP!"=="y" (
  rem –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ 'python39' –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ–≥–æ
  call conda create --prefix %ENV_PREFIX% python=3.9
  call conda activate %ENV_PREFIX%
)
rem –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if /i "!NEW_ENV_RSP!"=="n" (
  rem –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
  echo. >nul
)
rem –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É
if /i "!NEW_ENV_RSP!"=="a" (
  echo –í—ã—Ö–æ–¥ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞...
  exit /b 1
)
goto :eof
